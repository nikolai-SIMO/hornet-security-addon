<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hornet Security Encryption Tags</title>
    
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 350px;
            margin: 0 auto;
        }
        
        h1 {
            color: #0078d4;
            font-size: 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }
        
        .encryption-options {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .option {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f9f9f9;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .option:hover {
            background: #e9f5ff;
            transform: translateX(5px);
        }
        
        .option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 15px;
            cursor: pointer;
        }
        
        .option-label {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
        }
        
        .option-description {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .apply-btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        .apply-btn:hover {
            background: #106ebe;
        }
        
        .apply-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }
        
        .status-message.success {
            background: #d4f4dd;
            color: #0e7c2a;
            border: 1px solid #0e7c2a;
            display: block;
        }
        
        .status-message.error {
            background: #fdd;
            color: #c00;
            border: 1px solid #c00;
            display: block;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #0d47a1;
            border: 1px solid #0d47a1;
            display: block;
        }
        
        .current-tags {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .current-tags.visible {
            display: block;
        }
        
        .remove-tags-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .remove-tags-btn:hover {
            background: #c82333;
        }
        
        .logo {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>üîê</span>
            Hornet Security
        </h1>
        <div class="subtitle">Select encryption methods for this email</div>
        
        <div class="current-tags" id="currentTags">
            <strong>Current tags:</strong> <span id="currentTagsList"></span>
            <br>
            <button class="remove-tags-btn" onclick="removeTags()">Remove All Tags</button>
        </div>
        
        <div class="encryption-options">
            <div class="option">
                <input type="checkbox" id="tls" name="encryption" value="TLS">
                <div>
                    <label for="tls" class="option-label">TLS</label>
                    <div class="option-description">Transport Layer Security encryption</div>
                </div>
            </div>
            
            <div class="option">
                <input type="checkbox" id="smime" name="encryption" value="S/MIME">
                <div>
                    <label for="smime" class="option-label">S/MIME</label>
                    <div class="option-description">Secure/Multipurpose Internet Mail Extensions</div>
                </div>
            </div>
            
            <div class="option">
                <input type="checkbox" id="pgp" name="encryption" value="PGP">
                <div>
                    <label for="pgp" class="option-label">PGP</label>
                    <div class="option-description">Pretty Good Privacy encryption</div>
                </div>
            </div>
            
            <div class="option">
                <input type="checkbox" id="websafe" name="encryption" value="Websafe">
                <div>
                    <label for="websafe" class="option-label">Websafe</label>
                    <div class="option-description">Web-based secure delivery</div>
                </div>
            </div>
            
            <div class="option">
                <input type="checkbox" id="emig" name="encryption" value="EmiG">
                <div>
                    <label for="emig" class="option-label">EmiG</label>
                    <div class="option-description">German authority encryption standard</div>
                </div>
            </div>
        </div>
        
        <button class="apply-btn" onclick="applyEncryptionTags()">Apply Encryption Tags</button>
        
        <div class="status-message" id="statusMessage"></div>
    </div>
    
    <script>
        // Initialize Office.js
        Office.initialize = function(reason) {
            // Check current subject for existing tags when add-in loads
            checkExistingTags();
        };
        
        // Check for existing encryption tags in the subject
        function checkExistingTags() {
            try {
                const item = Office.context.mailbox.item;
                
                item.subject.getAsync(function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        const subject = result.value || "";
                        const tags = extractTags(subject);
                        
                        if (tags.length > 0) {
                            document.getElementById('currentTagsList').textContent = tags.join(', ');
                            document.getElementById('currentTags').classList.add('visible');
                            
                            // Pre-check the checkboxes for existing tags
                            tags.forEach(tag => {
                                const checkbox = document.querySelector(`input[value="${tag}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            });
                        }
                    }
                });
            } catch (error) {
                console.error("Error checking tags:", error);
            }
        }
        
        // Extract existing tags from subject
        function extractTags(subject) {
            const tagPattern = /\[(TLS|S\/MIME|PGP|Websafe|EmiG)\]/gi;
            const matches = subject.match(tagPattern);
            if (matches) {
                return matches.map(tag => tag.replace(/[\[\]]/g, ''));
            }
            return [];
        }
        
        // Remove all encryption tags from subject
        function removeTags() {
            try {
                const item = Office.context.mailbox.item;
                
                item.subject.getAsync(function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        let subject = result.value || "";
                        
                        // Remove all encryption tags
                        subject = subject.replace(/\[(TLS|S\/MIME|PGP|Websafe|EmiG)\]\s*/gi, '').trim();
                        
                        // Set the cleaned subject
                        item.subject.setAsync(subject, function(result) {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                showStatus("All encryption tags removed", "success");
                                document.getElementById('currentTags').classList.remove('visible');
                                
                                // Uncheck all checkboxes
                                document.querySelectorAll('input[name="encryption"]').forEach(cb => {
                                    cb.checked = false;
                                });
                            } else {
                                showStatus("Failed to remove tags: " + result.error.message, "error");
                            }
                        });
                    }
                });
            } catch (error) {
                showStatus("Error: " + error.message, "error");
            }
        }
        
        // Apply selected encryption tags to email subject
        function applyEncryptionTags() {
            try {
                // Get selected encryption methods
                const checkboxes = document.querySelectorAll('input[name="encryption"]:checked');
                
                if (checkboxes.length === 0) {
                    showStatus("Please select at least one encryption method", "info");
                    return;
                }
                
                // Build tags string
                const tags = Array.from(checkboxes).map(cb => `[${cb.value}]`).join('');
                
                // Get the current email item
                const item = Office.context.mailbox.item;
                
                // Get current subject
                item.subject.getAsync(function(result) {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        let currentSubject = result.value || "";
                        
                        // Remove any existing encryption tags first
                        currentSubject = currentSubject.replace(/\[(TLS|S\/MIME|PGP|Websafe|EmiG)\]\s*/gi, '').trim();
                        
                        // Add new tags at the beginning of the subject
                        const newSubject = tags + " " + currentSubject;
                        
                        // Set the new subject with encryption tags
                        item.subject.setAsync(newSubject.trim(), function(result) {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                showStatus("Encryption tags applied successfully!", "success");
                                
                                // Update current tags display
                                const selectedTags = Array.from(checkboxes).map(cb => cb.value);
                                document.getElementById('currentTagsList').textContent = selectedTags.join(', ');
                                document.getElementById('currentTags').classList.add('visible');
                            } else {
                                showStatus("Failed to apply tags: " + result.error.message, "error");
                            }
                        });
                    } else {
                        showStatus("Failed to get subject: " + result.error.message, "error");
                    }
                });
                
            } catch (error) {
                showStatus("Error: " + error.message, "error");
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            
            // Hide after 3 seconds
            setTimeout(() => {
                statusDiv.className = 'status-message';
            }, 3000);
        }
        
        // Make option divs clickable
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                    }
                });
            });
        });
    </script>
</body>
</html>
