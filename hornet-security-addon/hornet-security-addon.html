<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hornet Security Encryption Tags</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .dot-green {
            background-color: #28a745;
        }
        
        .dot-red {
            background-color: #dc3545;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #ff6b35;
        }
        
        .tags-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }
        
        .tag-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .tag-item:hover {
            background-color: #f8f9fa;
        }
        
        .tag-item:last-child {
            border-bottom: none;
        }
        
        .tag-item.selected {
            background-color: #fff3cd;
            border-left: 4px solid #ff6b35;
        }
        
        .tag-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
        
        .tag-item.disabled:hover {
            background-color: #f8f9fa;
        }
        
        .tag-info {
            flex-grow: 1;
        }
        
        .tag-name {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 2px;
        }
        
        .tag-description {
            font-size: 12px;
            color: #6c757d;
        }
        
        .tag-level {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .level-low {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .level-medium {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .level-high {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .level-critical {
            background-color: #721c24;
            color: white;
        }
        
        .selected-tags {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #ff6b35;
        }
        
        .selected-tags-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .selected-tag {
            display: inline-block;
            background-color: #ff6b35;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px 4px 2px 0;
            cursor: pointer;
        }
        
        .selected-tag:hover {
            background-color: #e55a2b;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #ff6b35;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #e55a2b;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .settings-link {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .settings-link a {
            color: #ff6b35;
            text-decoration: none;
        }
        
        .settings-link a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e9ecef;
            border-top: 2px solid #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">H</div>
            <div class="title">Hornet Security Encryption Tags</div>
        </div>
        
        <div id="connectionStatus" class="connection-status disconnected">
            <span class="status-dot dot-red"></span>
            <span>Connecting to Hornet Security...</span>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        
        <input type="text" class="search-box" id="searchBox" placeholder="Search encryption tags..." />
        
        <div id="loadingState" class="loading">Loading encryption tags</div>
        
        <div id="tagsContainer" class="tags-container" style="display: none;"></div>
        
        <div id="selectedTags" class="selected-tags" style="display: none;">
            <div class="selected-tags-title">Selected Tags:</div>
            <div id="selectedTagsList"></div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="applyTags" disabled>Apply Tags</button>
            <button class="btn btn-secondary" id="clearTags">Clear All</button>
        </div>
        
        <div class="settings-link">
            <a href="#" id="settingsLink">API Configuration</a>
        </div>
    </div>

    <script>
        // Global variables
        let encryptionTags = [];
        let selectedTags = new Set();
        let isConnected = false;
        
        // Hornet Security encryption tags based on actual system
        const mockEncryptionTags = [
            {
                id: 'tls-no-reference',
                name: 'TLS - No reference',
                description: 'Transport Layer Security without reference tracking',
                level: 'medium',
                category: 'transport',
                enabled: true
            },
            {
                id: 'smime-sign',
                name: 'S/MIME - SIGN',
                description: 'S/MIME digital signature for email authentication',
                level: 'high',
                category: 'signature',
                enabled: true
            },
            {
                id: 'pgp',
                name: 'PGP',
                description: 'Pretty Good Privacy encryption for secure communication',
                level: 'high',
                category: 'encryption',
                enabled: true
            },
            {
                id: 'websafe',
                name: 'Websafe',
                description: 'Web-based secure delivery and access control',
                level: 'medium',
                category: 'delivery',
                enabled: true
            },
            {
                id: 'emig',
                name: 'EmiG',
                description: 'Encrypted message in Germany compliance',
                level: 'critical',
                category: 'compliance',
                enabled: false
            }
        ];
        
        // Office.js initialization with proper error handling
        function initializeOffice() {
            // Wait for Office.js to load if we're in an Office environment
            if (typeof Office !== 'undefined' && Office.onReady) {
                Office.onReady((info) => {
                    console.log('Office.js loaded successfully');
                    console.log('Host application:', info.host);
                    
                    if (info.host === Office.HostType.Outlook) {
                        console.log('Running in Outlook - full functionality enabled');
                        updateConnectionStatus(true, 'Connected to Outlook');
                    } else {
                        console.log('Running in different Office host');
                        updateConnectionStatus(true, 'Connected to Office (not Outlook)');
                    }
                    
                    setupEventListeners();
                    initializeAddin();
                });
            } else {
                // We're not in an Office environment - this is expected during development
                console.log('Development mode - Office.js not loaded');
                updateConnectionStatus(false, 'Development mode - Deploy to Outlook for full functionality');
                setupEventListeners();
                initializeAddin();
            }
        }
        
        function setupEventListeners() {
            document.getElementById('searchBox').addEventListener('input', filterTags);
            document.getElementById('applyTags').addEventListener('click', applyEncryptionTags);
            document.getElementById('clearTags').addEventListener('click', clearAllTags);
            document.getElementById('settingsLink').addEventListener('click', showSettings);
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeOffice);
        } else {
            initializeOffice();
        }
        
        async function initializeAddin() {
            try {
                // Simulate API connection to Hornet Security
                await simulateApiConnection();
                await loadEncryptionTags();
                
                // Update status based on environment
                if (typeof Office !== 'undefined' && Office.context && Office.context.mailbox) {
                    updateConnectionStatus(true, 'Ready - Hornet Security integration active');
                } else {
                    updateConnectionStatus(true, 'Development mode - Ready for deployment');
                }
            } catch (error) {
                showError('Failed to connect to Hornet Security API: ' + error.message);
                updateConnectionStatus(false, 'API connection failed');
            }
        }
        
        async function simulateApiConnection() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve();
                }, 1500);
            });
        }
        
        async function loadEncryptionTags() {
            // In production, this would make an actual API call to Hornet Security
            // For demo purposes, we're using mock data
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    encryptionTags = mockEncryptionTags;
                    renderTags(encryptionTags);
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('tagsContainer').style.display = 'block';
                    resolve();
                }, 1000);
            });
        }
        
        function updateConnectionStatus(connected, customMessage = null) {
            isConnected = connected;
            const statusElement = document.getElementById('connectionStatus');
            const statusDot = statusElement.querySelector('.status-dot');
            const statusText = statusElement.querySelector('span:last-child');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusDot.className = 'status-dot dot-green';
                statusText.textContent = customMessage || 'Connected to Hornet Security';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusDot.className = 'status-dot dot-red';
                statusText.textContent = customMessage || 'Connection failed - Check API settings';
            }
        }
        
        function renderTags(tags) {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            
            if (tags.length === 0) {
                container.innerHTML = '<div class="no-results">No encryption tags found</div>';
                return;
            }
            
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                const isDisabled = !tag.enabled;
                const baseClass = isDisabled ? 'tag-item disabled' : 'tag-item';
                const selectedClass = selectedTags.has(tag.id) ? 'selected' : '';
                
                tagElement.className = `${baseClass} ${selectedClass}`;
                
                if (!isDisabled) {
                    tagElement.onclick = () => toggleTag(tag.id);
                }
                
                const statusIndicator = tag.enabled 
                    ? '<span style="color: #28a745; font-size: 12px; margin-left: 8px;">✓</span>'
                    : '<span style="color: #dc3545; font-size: 12px; margin-left: 8px;">✗</span>';
                
                tagElement.innerHTML = `
                    <div class="tag-info">
                        <div class="tag-name">${tag.name}${statusIndicator}</div>
                        <div class="tag-description">${tag.description}</div>
                    </div>
                    <div class="tag-level level-${tag.level}">${tag.level}</div>
                `;
                
                container.appendChild(tagElement);
            });
        }
        
        function filterTags() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filteredTags = encryptionTags.filter(tag => 
                tag.name.toLowerCase().includes(searchTerm) ||
                tag.description.toLowerCase().includes(searchTerm) ||
                tag.category.toLowerCase().includes(searchTerm)
            );
            renderTags(filteredTags);
        }
        
        function toggleTag(tagId) {
            const tag = encryptionTags.find(t => t.id === tagId);
            
            // Don't allow selection of disabled tags
            if (tag && !tag.enabled) {
                return;
            }
            
            if (selectedTags.has(tagId)) {
                selectedTags.delete(tagId);
            } else {
                selectedTags.add(tagId);
            }
            
            updateSelectedTagsDisplay();
            updateTagSelection();
            updateApplyButton();
        }
        
        function updateSelectedTagsDisplay() {
            const selectedTagsContainer = document.getElementById('selectedTags');
            const selectedTagsList = document.getElementById('selectedTagsList');
            
            if (selectedTags.size === 0) {
                selectedTagsContainer.style.display = 'none';
                return;
            }
            
            selectedTagsContainer.style.display = 'block';
            selectedTagsList.innerHTML = '';
            
            selectedTags.forEach(tagId => {
                const tag = encryptionTags.find(t => t.id === tagId);
                if (tag) {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'selected-tag';
                    tagElement.textContent = tag.name;
                    tagElement.onclick = () => toggleTag(tagId);
                    selectedTagsList.appendChild(tagElement);
                }
            });
        }
        
        function updateTagSelection() {
            const tagItems = document.querySelectorAll('.tag-item');
            const currentlyRenderedTags = document.getElementById('searchBox').value 
                ? encryptionTags.filter(tag => 
                    tag.name.toLowerCase().includes(document.getElementById('searchBox').value.toLowerCase()) ||
                    tag.description.toLowerCase().includes(document.getElementById('searchBox').value.toLowerCase()) ||
                    tag.category.toLowerCase().includes(document.getElementById('searchBox').value.toLowerCase())
                )
                : encryptionTags;
            
            tagItems.forEach((item, index) => {
                const tag = currentlyRenderedTags[index];
                if (tag) {
                    const isSelected = selectedTags.has(tag.id);
                    const isDisabled = !tag.enabled;
                    
                    // Remove existing classes
                    item.classList.remove('selected', 'disabled');
                    
                    // Add appropriate classes
                    if (isDisabled) {
                        item.classList.add('disabled');
                    }
                    if (isSelected && !isDisabled) {
                        item.classList.add('selected');
                    }
                }
            });
        }
        
        function updateApplyButton() {
            const applyButton = document.getElementById('applyTags');
            applyButton.disabled = selectedTags.size === 0 || !isConnected;
        }
        
        async function applyEncryptionTags() {
            if (selectedTags.size === 0) return;
            
            try {
                const selectedTagNames = Array.from(selectedTags).map(tagId => {
                    const tag = encryptionTags.find(t => t.id === tagId);
                    return tag ? tag.name : tagId;
                });
                
                // Check if we're running in Outlook
                if (typeof Office !== 'undefined' && Office.context && Office.context.mailbox) {
                    const item = Office.context.mailbox.item;
                    
                    // Create the encryption note for Hornet Security processing
                    const encryptionNote = `\n\n[HORNET SECURITY ENCRYPTION: ${selectedTagNames.join(', ')}]\n`;
                    
                    // Get current body and append encryption info
                    item.body.getAsync(Office.CoercionType.Text, (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            const newBody = result.value + encryptionNote;
                            item.body.setAsync(newBody, {coercionType: Office.CoercionType.Text});
                        }
                    });
                } else {
                    // Fallback for testing - just show the tags that would be applied
                    console.log('Would apply encryption tags:', selectedTagNames);
                    alert('Demo Mode: Would apply encryption tags:\n' + selectedTagNames.join('\n'));
                }
                
                // Show success message
                showSuccess(`Applied ${selectedTags.size} encryption tag(s) successfully`);
                
                // Clear selections
                clearAllTags();
                
            } catch (error) {
                showError('Failed to apply encryption tags: ' + error.message);
            }
        }
        
        function clearAllTags() {
            selectedTags.clear();
            updateSelectedTagsDisplay();
            updateTagSelection();
            updateApplyButton();
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            // Create temporary success message
            const successElement = document.createElement('div');
            successElement.className = 'connection-status connected';
            successElement.innerHTML = `<span class="status-dot dot-green"></span><span>${message}</span>`;
            
            const container = document.querySelector('.container');
            const header = document.querySelector('.header');
            container.insertBefore(successElement, header.nextSibling);
            
            setTimeout(() => {
                successElement.remove();
            }, 3000);
        }
        
        function showSettings() {
            // In production, this would open a settings dialog
            // For demo purposes, show an alert
            alert('API Configuration:\n\nIn production, this would open a dialog to configure:\n- Hornet Security API endpoint\n- Authentication credentials\n- Tag synchronization settings\n- Encryption preferences');
        }
    </script>
</body>
</html>